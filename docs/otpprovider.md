# Module Documentation: otpprovider/

The `otpprovider/` module integrates Two-Factor Authentication (2FA) into the `xcore` framework using Time-based One-Time Passwords (TOTP). It enables users to set up and verify OTP devices, commonly used with authenticator apps like Google Authenticator.

## Files and Their Roles

*   **`otpprovider/__init__.py`**: (Likely empty or for package initialization).
*   **`otpprovider/dependencies.py`**: This file is currently empty, suggesting that OTP verification is not enforced as a universal FastAPI dependency but rather handled explicitly via API routes or service calls where 2FA is required.
*   **`otpprovider/models.py`**:
    *   Defines the `OTPDevice` SQLAlchemy model, which maps to the `otp_devices` table in the database.
    *   Stores essential details for an OTP device, including its `id`, `user_id` (linking to the `User` model), the `secret` key used for TOTP generation, `is_active` status, creation timestamp, and last verification timestamp.
    *   Includes the `user_otp` association table for potential many-to-many relationships between users and OTP devices.
*   **`otpprovider/routes.py`**:
    *   Implements the `optProvider` FastAPI `APIRouter` for OTP-related API endpoints.
    *   Provides endpoints for enabling OTP for a user and for verifying an OTP code.
*   **`otpprovider/schemas.py`**:
    *   Defines Pydantic models (`OTPDeviceCreate`, `OTPDeviceRead`, `OTPVerifyRequest`) for data validation and serialization of OTP-related API requests and responses.
*   **`otpprovider/service.py`**:
    *   Contains the business logic for OTP operations.
    *   Functions include `create_otp_device` (to generate a secret and register a new device), `verify_otp` (to validate a user-provided OTP code), and `deactivate_otp` (to disable an existing OTP device).
*   **`otpprovider/utils.py`**:
    *   Provides utility functions that wrap the `pyotp` library.
    *   Includes functions to `generate_secret` (a random base32 string), `get_totp` (to get a `pyotp.TOTP` object), `generate_qr_uri` (to create an `otpauth://` URI for QR code generation), and `verify_code` (to check an OTP code against a secret).

## Key Concepts and Functionality

### Time-Based One-Time Passwords (TOTP)

The module implements TOTP, a common standard for 2FA. TOTP codes are short numeric codes that are valid for a limited time period (typically 30 or 60 seconds) and are generated using a shared secret key and the current time.

### OTP Device Management

*   **Enabling OTP**: A user can enable 2FA by sending a request to `/otp/enable`. The system generates a unique secret, registers an `OTPDevice` for the user, and provides a "provisioning URI". This URI can be converted into a QR code that the user scans with an authenticator app.
*   **Verification**: When a user needs to authenticate with 2FA, they provide an OTP code generated by their authenticator app to the `/otp/verify` endpoint. The system uses the stored secret to verify the code's validity.
*   **Deactivation**: OTP devices can be deactivated, disabling 2FA for a user.

### Secure Secret Handling

The `secret` generated for each OTP device is crucial for security. While stored in the database, it's never directly exposed to the client in plain text after the initial setup. The provisioning URI helps in the initial client setup.

## API Endpoints (`/otp`)

The `optProvider` provides the following API endpoints:

*   **POST `/otp/enable`**:
    *   **Description**: Creates and enables a new OTP device for a given user.
    *   **Request Body**: `OTPDeviceCreate` (user_id).
    *   **Response**: `OTPDeviceRead` (including the `secret` and `provisioning_uri` for initial setup).
*   **POST `/otp/verify`**:
    *   **Description**: Verifies a TOTP code provided by the user against their active OTP device.
    *   **Request Body**: `OTPVerifyRequest` (user_id, otp_code).
    *   **Response**: A dictionary indicating the verification `status` (e.g., "verified").

## Integration with Other Modules

*   **`auth/init_root.py`**: The `otpprovider` module is used during the `auth` module's root user initialization to automatically set up a 2FA device for the root administrator.
*   **`database/db.py`**: Relies on `database.db.get_db` for database session management.
*   **`auth/models.py`**: The `User` model in the `auth` module has a relationship with `OTPDevice` to track a user's associated OTP devices.
