name: PR â€“ Quality Gate

on:
  pull_request:
    branches: [features, main]
    types: [opened, synchronize, reopened, ready_for_review]

jobs:

  # â”€â”€ VÃ©rification du titre de la PR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  pr-title:
    name: ğŸ“‹ PR Title Check
    runs-on: ubuntu-latest
    steps:
      - name: Check Conventional Commits format
        uses: amannn/action-semantic-pull-request@v5
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          types: |
            feat
            fix
            docs
            refactor
            test
            chore
            perf
            ci
          requireScope: false
          subjectPattern: ^.{1,80}$
          subjectPatternError: |
            Le titre de la PR doit respecter le format Conventional Commits :
            feat(scope): description courte
            fix: correction de bug
            docs: mise Ã  jour de la documentation

  # â”€â”€ Auto-label selon les fichiers modifiÃ©s â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  labeler:
    name: ğŸ·ï¸ Auto Label
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
    steps:
      - uses: actions/labeler@v5
        with:
          repo-token: ${{ secrets.GITHUB_TOKEN }}
          configuration-path: .github/labeler.yml
          sync-labels: true

  # â”€â”€ Taille de la PR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  pr-size:
    name: ğŸ“ PR Size Check
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check PR size
        run: |
          ADDITIONS=$(gh pr view ${{ github.event.pull_request.number }} \
            --json additions --jq '.additions')
          DELETIONS=$(gh pr view ${{ github.event.pull_request.number }} \
            --json deletions --jq '.deletions')
          TOTAL=$((ADDITIONS + DELETIONS))

          echo "Lines changed: +$ADDITIONS / -$DELETIONS (total: $TOTAL)"

          if [ $TOTAL -gt 800 ]; then
            gh pr comment ${{ github.event.pull_request.number }} --body \
              "âš ï¸ **PR trÃ¨s large** ($TOTAL lignes modifiÃ©es). Pensez Ã  la dÃ©couper en plusieurs PRs plus petites pour faciliter la revue."
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # â”€â”€ VÃ©rification des fichiers de plugin â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  check-plugins:
    name: ğŸ”Œ Plugin Files Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Check modified plugins have config.yaml
        run: |
          MODIFIED=$(git diff --name-only origin/${{ github.base_ref }}...HEAD \
            | grep '^plugins/' | cut -d'/' -f1,2 | sort -u)

          for plugin_dir in $MODIFIED; do
            if [ -d "$plugin_dir" ]; then
              if [ ! -f "$plugin_dir/config.yaml" ]; then
                echo "âš ï¸ Warning: $plugin_dir is missing config.yaml"
              fi
              if [ ! -f "$plugin_dir/__init__.py" ]; then
                echo "âŒ Error: $plugin_dir is missing __init__.py"
                exit 1
              fi
              if [ ! -f "$plugin_dir/run.py" ]; then
                echo "âŒ Error: $plugin_dir is missing run.py"
                exit 1
              fi
              echo "âœ“ $plugin_dir structure OK"
            fi
          done

  # â”€â”€ VÃ©rification que les tests passent â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  quick-test:
    name: âš¡ Quick Test
    runs-on: ubuntu-latest
    if: github.event.pull_request.draft == false
    steps:
      - uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.13"

      - name: Install Poetry
        uses: snok/install-poetry@v1
        with:
          virtualenvs-in-project: true

      - name: Cache deps
        uses: actions/cache@v4
        with:
          path: .venv
          key: venv-pr-${{ hashFiles('poetry.lock') }}

      - name: Install deps
        run: poetry install --no-interaction

      - name: Run tests
        env:
          DATABASE_URL: sqlite:///./test.db
          SECRET_KEY: pr-test-key
        run: poetry run pytest tests/ -q --tb=short -x
        # -x : stoppe au premier Ã©chec

  # â”€â”€ RÃ©sumÃ© â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  pr-gate:
    name: âœ… PR Gate
    runs-on: ubuntu-latest
    needs: [pr-title, check-plugins, quick-test]
    if: always()
    steps:
      - name: Evaluate gate
        run: |
          if [[ "${{ needs.pr-title.result }}"    == "failure" ||
                "${{ needs.check-plugins.result }}" == "failure" ||
                "${{ needs.quick-test.result }}"    == "failure" ]]; then
            echo "PR gate FAILED â€“ merge bloquÃ©"
            exit 1
          fi
          echo "PR gate PASSED âœ“"
